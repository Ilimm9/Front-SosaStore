<div class="row my-5">
  <div class="col-xl-8 col-md-10 mx-auto">
    <div class="card shadow p-4">
      <h3 class="card-title text-center mb-4">Formulario para Productos</h3>
      <hr class="divider" />
      <form #productoForm="ngForm" (ngSubmit)="guardar()" novalidate>
        <div class="mb-3">
          <label for="nombre" class="form-label">Nombre</label>
          <input
            type="text"
            class="form-control"
            id="nombre"
            name="nombre"
            [(ngModel)]="producto.nombre"
            placeholder="Ingrese el nombre del producto"
            required
            minlength="3"
            pattern="^[a-zA-Z0-9\s-_]+$"
            #nombre="ngModel"
          />
          @if(nombre.invalid && nombre.touched){
          <div class="alert alert-danger mt-2 text-center">
            @if(nombre.errors?.['required']){
            <small>El nombre es requerido</small>
            } @else if (nombre.errors?.['minlength']){
            <small>Debe tener al menos 3 caracteres</small>
            } @else if (nombre.errors?.['pattern']){
            <small
              >Solo se permiten letras ,numeros, espacios y los caracteres - y
              _</small
            >
            }
          </div>
          }
        </div>

        <div class="mb-3">
          <label for="codigoProducto" class="form-label">Código</label>
          <input
            type="text"
            class="form-control readonly-input"
            id="codigoProducto"
            name="codigoProducto"
            [(ngModel)]="producto.codigoProducto"
            class="form-control readonly-input"
            required
            value=""
            readonly
            #codigoProducto="ngModel"
          />
        </div>

        <div class="mb-3">
          <label for="stock" class="form-label">Stock</label>
          <input
            type="number"
            class="form-control"
            id="stock"
            name="stock"
            [(ngModel)]="producto.stock"
            placeholder="Ingrese el stock del producto"
            required
            pattern="^[1-9][0-9]*$"
            #stock="ngModel"
          />
          @if(stock.invalid && stock.touched){
          <div class="alert alert-danger mt-2 text-center">
            @if(stock.errors?.['required']){
            <small>El stock es requerido</small>
            } @else if (stock.errors?.['pattern']){
            <small>Solo se permiten numeros enteros mayores a cero</small>
            }
          </div>
          }
        </div>

        <div class="mb-3">
          <label for="stockMin" class="form-label">Stock Minimo</label>
          <input
            type="text"
            class="form-control"
            id="stockMin"
            name="stockMin"
            [(ngModel)]="producto.stockMin"
            placeholder="Ingrese el stock minimo requerido"
            required
            pattern="^[1-9][0-9]*$"
            #stockMin="ngModel"
          />
          @if(stockMin.invalid && stockMin.touched){
          <div class="alert alert-danger mt-2 text-center">
            @if(stockMin.errors?.['required']){
            <small>El stock minimo es requerido</small>
            } @else if (stockMin.errors?.['pattern']){
            <small>Solo se permiten numeros enteros mayores a cero</small>
            }
          </div>
          }
        </div>

        <div class="mb-3">
          <label for="stockMax" class="form-label">Stock Maximo</label>
          <input
            type="text"
            class="form-control"
            id="stockMax"
            name="stockMax"
            [(ngModel)]="producto.stockMax"
            placeholder="Ingrese el stock maximo requerido"
            required
            pattern="^[1-9][0-9]*$"
            #stockMax="ngModel"
          />
          @if(stockMax.invalid && stockMax.touched){
          <div class="alert alert-danger mt-2 text-center">
            @if(stockMax.errors?.['required']){
            <small>El stock maximo es requerido</small>
            } @else if (stockMax.errors?.['pattern']){
            <small>Solo se permiten numeros enteros mayores a cero</small>
            }
          </div>
          }
        </div>

        <div class="mb-3">
          <label for="precioVenta" class="form-label">Precio de Venta</label>
          <input
            type="number"
            min="0"
            step="0.01"
            class="form-control"
            id="precioVenta"
            name="precioVenta"
            [(ngModel)]="producto.precioVenta"
            placeholder=""
            placeholder="Ingrese el precio de venta del producto"
            required
            #precioVenta="ngModel"
          />
          @if(precioVenta.invalid && precioVenta.touched){
          <div class="alert alert-danger mt-2 text-center">
            @if(precioVenta.errors?.['required']){
            <small>El precio de venta es requerido</small>
            }@else{
            <small>Formato incorrecto de precio</small>
            }
          </div>
          }
        </div>

        <div class="mb-3">
          <label for="precioCompra" class="form-label">Precio de Compra</label>
          <input
            type="number"
            min="0"
            step="0.01"
            class="form-control"
            id="precioCompra"
            name="precioCompra"
            [(ngModel)]="producto.precioCompra"
            placeholder=""
            placeholder="Ingrese el precio de compra del producto"
            required
            #precioCompra="ngModel"
          />
          @if(precioCompra.invalid && precioCompra.touched){
          <div class="alert alert-danger mt-2 text-center">
            @if(precioCompra.errors?.['required']){
            <small>El precio de compra es requerido</small>
            }@else {
            <small>Formato incorrecto de precio</small>
            }
          </div>
          }
        </div>

        <div class="mb-3 d-flex">
          <mat-form-field class="flex-grow-1" appearance="fill">
            <mat-label> {{producto.nombreCategoria ? producto.nombreCategoria : ''}}</mat-label>
            <input
                id="codigoCategoria"
                name="codigoCategoria"
                class="mat-form-field-grosor"
                type="text"
                placeholder="Buscar categoría"
                aria-label="Buscar"
                matInput
                [matAutocomplete]="auto"
              />
            
            <mat-autocomplete
              #auto="matAutocomplete"
              [displayWith]="displayCategoryName"
              (optionSelected)="onCategorySelected($event.option.value)"
            >
              <mat-option
                *ngFor="let categoria of filteredCategorias | async "
                [value]="categoria"
              >
                {{ categoria.nombre }}
              </mat-option>
            </mat-autocomplete>
          </mat-form-field>
          <div class="btn-grosor">
            <button
              type="button"
              class="btn btn-primary ms-2"
              (click)="abrirModal()"
            >
              Nueva Categoria
            </button>
          </div>
        </div>

        <div class="d-flex justify-content-evenly">
          @if(modoEdicion){
          <button
            type="button"
            class="btn btn-primary"
            [disabled]="productoForm.invalid"
            (click)="actualizarProducto()"
          >
            Editar
          </button>
          } @else {
          <button type="submit" class="btn btn-primary">Agregar</button>
          }
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal de Nueva Categoría -->
<div *ngIf="visibleModal" class="modal-backdrop">
  <div class="modal-content">
    <h2>Nueva Categoría</h2>
    <form
      #categoriaNForm="ngForm"
      (ngSubmit)="guardarNuevaCategoria()"
      novalidate
    >
      <div class="mb-3">
        <label for="codigoCategoria" class="form-label">Codigo Categoria</label>
        <input
          type="text"
          class="form-control"
          id="codigoCategoria"
          name="codigoCategoria"
          [(ngModel)]="nuevaCategoria.codigoCategoria"
          #codigoCategoria="ngModel"
        />
      </div>

      <div class="mb-3">
        <label for="nombre" class="form-label">Nombre</label>
        <input
          type="text"
          class="form-control"
          id="nombre"
          name="nombre"
          [(ngModel)]="nuevaCategoria.nombre"
          placeholder="Ingrese el nombre de la categoría"
          required
          minlength="3"
          pattern="^[a-zA-Z0-9\s-_]+$"
          #nombre="ngModel"
        />
        @if(nombre.invalid && nombre.touched){
        <div class="alert alert-danger mt-2 text-center">
          @if(nombre.errors?.['required']){
          <small>El nombre es requerido</small>
          } @else if (nombre.errors?.['minlength']){
          <small>Debe tener al menos 3 caracteres</small>
          } @else if (nombre.errors?.['pattern']){
          <small
            >Solo se permiten letras ,numeros, espacios y los caracteres - y
            _</small
          >
          }
        </div>
        }
      </div>

      <div class="mb-3">
        <label for="codigo" class="form-label">Descripción</label>
        <input
          type="text"
          class="form-control"
          id="descripcion"
          name="descripcion"
          [(ngModel)]="nuevaCategoria.descripcion"
          #descripcion="ngModel"
        />
        @if(descripcion.invalid && descripcion.touched){
        <div class="alert alert-danger mt-2 text-center">
          @if (nombre.errors?.['pattern']){
          <small
            >Solo se permiten letras ,numeros, espacios y los caracteres - y
            _</small
          >
          }
        </div>
        }
      </div>
      <div class="mt-3">
        <button type="submit" class="btn btn-primary">Guardar</button>
        <button
          type="button"
          class="btn btn-danger ms-2"
          (click)="cerrarModal()"
        >
          Descartar
        </button>
      </div>
    </form>
  </div>
</div>
